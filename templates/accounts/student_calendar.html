{% extends 'base_with_sidebar.html' %}
{% load static %}

{% block title %}Mon Calendrier - eSchool{% endblock %}

{% block extra_css %}
<style>
    .calendar-view-toggle button.active {
        background-color: #3b82f6;
        color: white;
    }
    
    .event-badge {
        transition: all 0.2s ease;
    }
    
    .event-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .calendar-day {
        transition: all 0.2s ease;
    }
    
    .calendar-day:hover {
        background-color: #f3f4f6;
    }
    
    .time-slot {
        min-height: 80px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .event-card {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .event-card:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    [x-cloak] { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div x-data="calendarApp()" x-init="init()">
    <!-- En-tête -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                    <span class="material-icons text-blue-600 mr-3 text-4xl">event</span>
                    Mon Calendrier Académique
                </h1>
                <p class="mt-2 text-gray-600">Gérez vos cours, devoirs et examens</p>
            </div>
            
            <!-- Boutons de vue -->
            <div class="flex gap-2 calendar-view-toggle">
                <button @click="currentView = 'list'; updateView()" 
                        :class="{ 'active': currentView === 'list' }"
                        class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 flex items-center gap-2">
                    <span class="material-icons text-sm">view_list</span>
                    <span class="hidden md:inline">Liste</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-sm p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-sm">Cours cette semaine</p>
                    <p class="text-3xl font-bold mt-1" x-text="stats.classes"></p>
                </div>
                <span class="material-icons text-5xl opacity-20">school</span>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-sm p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-orange-100 text-sm">Devoirs à rendre</p>
                    <p class="text-3xl font-bold mt-1" x-text="stats.assignments"></p>
                </div>
                <span class="material-icons text-5xl opacity-20">assignment</span>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-sm p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-red-100 text-sm">Examens prévus</p>
                    <p class="text-3xl font-bold mt-1" x-text="stats.exams"></p>
                </div>
                <span class="material-icons text-5xl opacity-20">quiz</span>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-sm p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-sm">Taux de présence</p>
                    <p class="text-3xl font-bold mt-1">95%</p>
                </div>
                <span class="material-icons text-5xl opacity-20">check_circle</span>
            </div>
        </div>
    </div>

    <!-- Vue Liste -->
    <div class="space-y-6">
        <template x-for="(events, date) in eventsByDate" :key="date">
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                    <h3 class="font-semibold text-gray-900" x-text="formatDate(date)"></h3>
                </div>
                <div class="divide-y divide-gray-200">
                    <template x-for="event in events" :key="event.title + event.time">
                        <div @click="showEventDetail(event)"
                             class="event-card p-6 hover:bg-gray-50 flex items-start gap-4">
                            <div class="flex-shrink-0">
                                <div class="w-16 h-16 rounded-lg flex flex-col items-center justify-center"
                                     :class="{
                                         'bg-red-100 text-red-700': event.type === 'exam',
                                         'bg-orange-100 text-orange-700': event.type === 'assignment',
                                         'bg-green-100 text-green-700': event.type === 'class'
                                     }">
                                    <span class="material-icons" x-text="getEventIcon(event.type)"></span>
                                    <span class="text-xs mt-1" x-text="event.time"></span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-lg text-gray-900" x-text="event.title"></h4>
                                <p class="text-gray-600 mt-1" x-text="event.description"></p>
                                <div class="flex items-center gap-4 mt-2 text-sm text-gray-500">
                                    <span class="flex items-center gap-1">
                                        <span class="material-icons text-sm">schedule</span>
                                        <span x-text="event.duration + ' min'"></span>
                                    </span>
                                    <span class="flex items-center gap-1" x-show="event.teacher">
                                        <span class="material-icons text-sm">person</span>
                                        <span x-text="event.teacher"></span>
                                    </span>
                                    <span class="flex items-center gap-1" x-show="event.room">
                                        <span class="material-icons text-sm">room</span>
                                        <span x-text="event.room"></span>
                                    </span>
                                </div>
                            </div>
                            <div>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                                      :class="{
                                          'bg-red-100 text-red-800': event.importance === 'high',
                                          'bg-yellow-100 text-yellow-800': event.importance === 'medium',
                                          'bg-green-100 text-green-800': event.importance === 'normal'
                                      }"
                                      x-text="event.importance === 'high' ? 'Important' : event.importance === 'medium' ? 'Moyen' : 'Normal'">
                                </span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>
    </div>

    <!-- Modal -->
    <div x-show="selectedEvent" 
         x-cloak
         @click.self="selectedEvent = null"
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6" @click.stop>
            <div class="flex items-start justify-between mb-4">
                <h3 class="text-2xl font-bold text-gray-900" x-text="selectedEvent?.title"></h3>
                <button @click="selectedEvent = null" class="text-gray-400 hover:text-gray-600">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <div class="space-y-4" x-show="selectedEvent">
                <div class="flex items-center gap-3 text-gray-700">
                    <span class="material-icons text-gray-400">event</span>
                    <span x-text="selectedEvent?.date"></span>
                </div>
                <div class="flex items-center gap-3 text-gray-700">
                    <span class="material-icons text-gray-400">schedule</span>
                    <span x-text="selectedEvent?.time + ' (' + selectedEvent?.duration + ' minutes)'"></span>
                </div>
                <div class="flex items-center gap-3 text-gray-700" x-show="selectedEvent?.teacher">
                    <span class="material-icons text-gray-400">person</span>
                    <span x-text="selectedEvent?.teacher"></span>
                </div>
                <div class="flex items-center gap-3 text-gray-700" x-show="selectedEvent?.room">
                    <span class="material-icons text-gray-400">room</span>
                    <span x-text="selectedEvent?.room"></span>
                </div>
                <div class="border-t pt-4">
                    <p class="text-gray-600" x-text="selectedEvent?.description"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function calendarApp() {
    return {
        currentView: 'list',
        currentDate: new Date(),
        selectedEvent: null,
        events: {{ events|safe }},
        eventsByDate: {},
        stats: {
            classes: 0,
            assignments: 0,
            exams: 0
        },
        
        init() {
            this.updateView();
            this.calculateStats();
        },
        
        updateView() {
            this.organizeEventsByDate();
        },
        
        organizeEventsByDate() {
            this.eventsByDate = {};
            this.events.forEach(event => {
                if (!this.eventsByDate[event.date]) {
                    this.eventsByDate[event.date] = [];
                }
                this.eventsByDate[event.date].push(event);
            });
        },
        
        calculateStats() {
            const today = new Date();
            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            this.stats.classes = this.events.filter(e => e.type === 'class' && 
                new Date(e.date) >= today && new Date(e.date) <= weekFromNow).length;
            this.stats.assignments = this.events.filter(e => e.type === 'assignment' && 
                new Date(e.date) >= today).length;
            this.stats.exams = this.events.filter(e => e.type === 'exam' && 
                new Date(e.date) >= today).length;
        },
        
        showEventDetail(event) {
            this.selectedEvent = event;
        },
        
        formatDate(dateStr) {
            const date = new Date(dateStr);
            const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            const months = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 
                          'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];
            return days[date.getDay()] + ' ' + date.getDate() + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
        },
        
        getEventIcon(type) {
            return {
                'exam': 'quiz',
                'assignment': 'assignment',
                'class': 'school'
            }[type] || 'event';
        }
    }
}
</script>
{% endblock %}
