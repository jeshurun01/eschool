{% extends "base.html" %}
{% load static %}

{% block title %}Faire l'appel - eSchool{% endblock %}

{% block page_title %}
  <span class="material-icons mr-2">how_to_reg</span> Prise de Présence
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
  <!-- En-tête avec design amélioré -->
  <div class="mb-8">
    <div class="bg-gradient-to-r from-indigo-600 to-purple-700 rounded-xl p-6 shadow-lg">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
        <div class="flex items-center space-x-4">
          <div class="bg-white/20 rounded-full p-3">
            <span class="material-icons text-white" style="font-size: 32px;">how_to_reg</span>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-white">Prise de Présence</h1>
            <p class="text-indigo-100">Enregistrer les présences et absences</p>
          </div>
        </div>
        <div class="mt-4 lg:mt-0">
          <a href="{% url 'academic:attendance_list' %}" 
             class="inline-flex items-center px-6 py-3 border-2 border-white bg-white/10 backdrop-blur-sm text-white rounded-lg hover:bg-white/20 transition-all duration-200">
            <span class="material-icons mr-2" style="font-size: 20px;">list</span>
            Voir la liste
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulaire de sélection -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <div class="flex items-center mb-6">
      <span class="material-icons text-blue-600 mr-3" style="font-size: 24px;">settings</span>
      <h3 class="text-xl font-semibold text-gray-900">Paramètres de l'appel</h3>
    </div>
    
    <form id="attendanceForm" method="post" class="space-y-6">
      {% csrf_token %}
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <span class="material-icons inline-block mr-1" style="font-size: 16px;">class</span>
            Classe *
          </label>
          <select name="classroom" id="classroomSelect" required 
                  class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
            <option value="">Sélectionner une classe</option>
            {% for classroom in classrooms %}
              <option value="{{ classroom.id }}">{{ classroom.name }} ({{ classroom.level.name }})</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <span class="material-icons inline-block mr-1" style="font-size: 16px;">subject</span>
            Matière *
          </label>
          <select name="subject" id="subjectSelect" required
                  class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
            <option value="">Sélectionner une matière</option>
            {% for subject in subjects %}
              <option value="{{ subject.id }}">{{ subject.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <span class="material-icons inline-block mr-1" style="font-size: 16px;">event</span>
            Date *
          </label>
          <input type="date" name="date" value="{{ today|date:'Y-m-d' }}" required 
                 class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
        </div>
      </div>

      <div class="flex justify-center">
        <button type="button" id="loadStudents" 
                class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-all duration-200 flex items-center shadow-lg hover:shadow-xl">
          <span class="material-icons mr-2" style="font-size: 20px;">group</span>
          Charger les élèves
        </button>
      </div>

      <!-- Section des élèves -->
      <div id="studentsSection" class="hidden">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="bg-gradient-to-r from-green-600 to-blue-600 p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
              <div class="flex items-center">
                <span class="material-icons text-white mr-3" style="font-size: 24px;">group</span>
                <h3 class="text-xl font-semibold text-white">Liste des élèves</h3>
              </div>
              <div class="mt-4 md:mt-0 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                <button type="button" id="markAllPresent" 
                        class="inline-flex items-center justify-center px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition-colors">
                  <span class="material-icons mr-1" style="font-size: 16px;">check_circle</span>
                  Tous présents
                </button>
                <button type="button" id="markAllAbsent" 
                        class="inline-flex items-center justify-center px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors">
                  <span class="material-icons mr-1" style="font-size: 16px;">cancel</span>
                  Tous absents
                </button>
              </div>
            </div>
          </div>

          <div id="studentsContainer" class="divide-y divide-gray-200">
            <!-- Les élèves seront chargés ici via JavaScript -->
          </div>

          <div class="bg-gray-50 px-6 py-4">
            <div class="flex flex-col sm:flex-row sm:justify-end space-y-3 sm:space-y-0 sm:space-x-4">
              <button type="button" id="cancelAttendance" 
                      class="inline-flex items-center justify-center px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors">
                <span class="material-icons mr-2" style="font-size: 18px;">close</span>
                Annuler
              </button>
              <button type="submit" 
                      class="inline-flex items-center justify-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors shadow-lg hover:shadow-xl">
                <span class="material-icons mr-2" style="font-size: 18px;">save</span>
                Enregistrer l'appel
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Message d'aide -->
  <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6 shadow-sm">
    <div class="flex">
      <div class="flex-shrink-0">
        <div class="bg-blue-100 rounded-full p-2">
          <span class="material-icons text-blue-600" style="font-size: 20px;">info</span>
        </div>
      </div>
      <div class="ml-4">
        <h3 class="text-lg font-semibold text-blue-900 mb-3">Instructions d'utilisation</h3>
        <div class="text-sm text-blue-800">
          <p class="mb-2">1. Sélectionnez la classe pour laquelle vous voulez faire l'appel</p>
          <p class="mb-2">2. Choisissez la matière et la date du cours</p>
          <p>3. Cliquez sur "Faire l'appel" pour commencer</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadStudentsBtn = document.getElementById('loadStudents');
    const studentsSection = document.getElementById('studentsSection');
    const studentsContainer = document.getElementById('studentsContainer');
    const classroomSelect = document.getElementById('classroomSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const attendanceForm = document.getElementById('attendanceForm');

    loadStudentsBtn.addEventListener('click', function() {
        const classroomId = classroomSelect.value;
        const subjectId = subjectSelect.value;
        
        if (!classroomId) {
            alert('Veuillez sélectionner une classe');
            return;
        }
        
        if (!subjectId) {
            alert('Veuillez sélectionner une matière');
            return;
        }

        loadStudents(classroomId);
    });

    function loadStudents(classroomId) {
        // Afficher le loading
        studentsContainer.innerHTML = `
            <div class="text-center py-12">
                <div class="inline-flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
                <div class="mt-4">
                    <h4 class="text-lg font-medium text-gray-900">Chargement des élèves</h4>
                    <p class="text-sm text-gray-600 mt-1">Veuillez patienter...</p>
                </div>
            </div>
        `;
        studentsSection.classList.remove('hidden');
        
        // Appel à l'API pour récupérer les élèves
        fetch(`/academic/api/classroom/${classroomId}/students/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    displayStudents(data.students, data.classroom_name);
                } else {
                    throw new Error(data.error || 'Erreur lors du chargement');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                studentsContainer.innerHTML = `
                    <div class="text-center py-12">
                        <div class="bg-red-50 rounded-lg p-6 mx-4">
                            <span class="material-icons text-red-500 mb-4" style="font-size: 48px;">error</span>
                            <h4 class="text-lg font-medium text-red-900 mb-2">Erreur de chargement</h4>
                            <p class="text-sm text-red-700">${error.message}</p>
                            <button onclick="location.reload()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                                Recharger la page
                            </button>
                        </div>
                    </div>
                `;
            });
    }

    function displayStudents(students, classroomName) {
        if (students.length === 0) {
            studentsContainer.innerHTML = `
                <div class="text-center py-12">
                    <div class="bg-yellow-50 rounded-lg p-6 mx-4">
                        <span class="material-icons text-yellow-500 mb-4" style="font-size: 48px;">school</span>
                        <h4 class="text-lg font-medium text-yellow-900 mb-2">Aucun élève trouvé</h4>
                        <p class="text-sm text-yellow-700">Aucun élève n'est inscrit dans cette classe pour le moment.</p>
                    </div>
                </div>
            `;
            return;
        }

        let html = `
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="material-icons text-blue-600 mr-2" style="font-size: 20px;">class</span>
                        <h4 class="font-semibold text-blue-900">Classe: ${classroomName}</h4>
                    </div>
                    <div class="bg-blue-100 px-3 py-1 rounded-full">
                        <span class="text-sm font-medium text-blue-800">${students.length} élève(s)</span>
                    </div>
                </div>
            </div>
        `;
        
        students.forEach((student, index) => {
            const isEven = index % 2 === 0;
            const initials = student.name.split(' ').map(n => n[0]).join('').slice(0, 2);
            
            html += `
                <div class="p-4 ${isEven ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50 transition-colors">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="h-12 w-12 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 flex items-center justify-center text-white font-semibold text-sm shadow-lg">
                                    ${initials}
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-base font-medium text-gray-900">${student.name}</div>
                                <div class="text-sm text-gray-500 flex items-center">
                                    <span class="material-icons mr-1" style="font-size: 14px;">badge</span>
                                    Matricule: ${student.matricule}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex flex-col space-y-3">
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                                <label class="attendance-option inline-flex items-center p-2 rounded-lg border-2 border-green-200 bg-green-50 hover:bg-green-100 cursor-pointer transition-colors ring-2 ring-green-500 ring-offset-2">
                                    <input type="radio" name="status_${student.id}" value="PRESENT" checked class="sr-only">
                                    <span class="material-icons text-green-600 mr-2" style="font-size: 18px;">check_circle</span>
                                    <span class="text-sm font-medium text-green-700">Présent</span>
                                </label>
                                <label class="attendance-option inline-flex items-center p-2 rounded-lg border-2 border-red-200 bg-red-50 hover:bg-red-100 cursor-pointer transition-colors">
                                    <input type="radio" name="status_${student.id}" value="ABSENT" class="sr-only">
                                    <span class="material-icons text-red-600 mr-2" style="font-size: 18px;">cancel</span>
                                    <span class="text-sm font-medium text-red-700">Absent</span>
                                </label>
                                <label class="attendance-option inline-flex items-center p-2 rounded-lg border-2 border-yellow-200 bg-yellow-50 hover:bg-yellow-100 cursor-pointer transition-colors">
                                    <input type="radio" name="status_${student.id}" value="LATE" class="sr-only">
                                    <span class="material-icons text-yellow-600 mr-2" style="font-size: 18px;">schedule</span>
                                    <span class="text-sm font-medium text-yellow-700">Retard</span>
                                </label>
                                <label class="attendance-option inline-flex items-center p-2 rounded-lg border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 cursor-pointer transition-colors">
                                    <input type="radio" name="status_${student.id}" value="EXCUSED" class="sr-only">
                                    <span class="material-icons text-blue-600 mr-2" style="font-size: 18px;">verified</span>
                                    <span class="text-sm font-medium text-blue-700">Excusé</span>
                                </label>
                            </div>
                            <div class="mt-3">
                                <input type="text" name="justification_${student.id}" placeholder="Justification (optionnelle)..." 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        studentsContainer.innerHTML = html;
        
        // Ajouter des événements pour les options de présence
        document.querySelectorAll('.attendance-option').forEach(label => {
            label.addEventListener('click', function() {
                const radio = this.querySelector('input[type="radio"]');
                const studentId = radio.name.split('_')[1];
                
                // Enlever les classes de sélection de toutes les options du même élève
                document.querySelectorAll(`input[name="status_${studentId}"]`).forEach(r => {
                    r.closest('label').classList.remove('ring-2', 'ring-offset-2', 'ring-green-500', 'ring-red-500', 'ring-yellow-500', 'ring-blue-500');
                });
                
                // Cocher le radio et ajouter les classes de sélection
                radio.checked = true;
                this.classList.add('ring-2', 'ring-offset-2');
                
                if (radio.value === 'PRESENT') this.classList.add('ring-green-500');
                if (radio.value === 'ABSENT') this.classList.add('ring-red-500');
                if (radio.value === 'LATE') this.classList.add('ring-yellow-500');
                if (radio.value === 'EXCUSED') this.classList.add('ring-blue-500');
            });
        });
    }

    // Boutons "Tous présents" et "Tous absents"
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'markAllPresent') {
            document.querySelectorAll('input[value="PRESENT"]').forEach(radio => {
                radio.closest('label').click();
            });
        }
        
        if (e.target && e.target.id === 'markAllAbsent') {
            document.querySelectorAll('input[value="ABSENT"]').forEach(radio => {
                radio.closest('label').click();
            });
        }
        
        if (e.target && e.target.id === 'cancelAttendance') {
            studentsSection.classList.add('hidden');
        }
    });

    // Validation du formulaire avant soumission
    attendanceForm.addEventListener('submit', function(e) {
        const studentsVisible = !studentsSection.classList.contains('hidden');
        
        if (!studentsVisible) {
            e.preventDefault();
            alert('Veuillez d\'abord charger les élèves avant de soumettre l\'appel.');
            return;
        }

        // Vérifier qu'au moins un élève a une présence sélectionnée
        const statusInputs = document.querySelectorAll('input[name^="status_"]:checked');
        if (statusInputs.length === 0) {
            e.preventDefault();
            alert('Veuillez sélectionner le statut de présence pour au moins un élève.');
            return;
        }

        // Confirmation avant soumission
        const classroomName = classroomSelect.options[classroomSelect.selectedIndex].text;
        const subjectName = subjectSelect.options[subjectSelect.selectedIndex].text;
        const date = document.querySelector('input[name="date"]').value;
        
        if (!confirm(`Confirmer l'enregistrement de l'appel ?\n\nClasse: ${classroomName}\nMatière: ${subjectName}\nDate: ${date}\n\nCette action ne peut pas être annulée.`)) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
