{% extends 'base.html' %}
{% load static %}

{% block title %}Centre de communication{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Centre de communication</h1>
                <p class="text-gray-600 mt-2">Communiquez avec les enseignants et l'administration</p>
            </div>
            <div class="flex space-x-4">
                <button onclick="showComposeModal()" 
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    Nouveau message
                </button>
                <a href="{% url 'accounts:parent_children_overview' %}" 
                   class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    Retour aux enfants
                </a>
            </div>
        </div>
    </div>

    <!-- Statistiques de communication -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-3.5a2 2 0 00-1.5.5l-2 2a2 2 0 01-1.5.5H9.5a2 2 0 01-1.5-.5l-2-2A2 2 0 004 13m16 0h-3.5"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Messages reçus</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ stats.received_count }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Messages envoyés</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ stats.sent_count }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM12 17H6a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v4.5"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Non lus</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ stats.unread_count }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Rendez-vous</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ stats.appointments_count }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Conversations récentes -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow-md">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Conversations</h3>
                    <div class="flex space-x-2">
                        <button onclick="filterMessages('all')" id="filter-all" 
                                class="filter-btn active px-3 py-1 text-sm bg-blue-500 text-white rounded">
                            Tous
                        </button>
                        <button onclick="filterMessages('unread')" id="filter-unread"
                                class="filter-btn px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            Non lus
                        </button>
                        <button onclick="filterMessages('teachers')" id="filter-teachers"
                                class="filter-btn px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            Enseignants
                        </button>
                        <button onclick="filterMessages('admin')" id="filter-admin"
                                class="filter-btn px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            Administration
                        </button>
                    </div>
                </div>
            </div>

            <div class="divide-y divide-gray-200 max-h-96 overflow-y-auto">
                {% if conversations %}
                    {% for conversation in conversations %}
                    <div class="conversation-item p-6 hover:bg-gray-50 cursor-pointer" 
                         data-type="{{ conversation.sender_type }}" 
                         data-read="{{ conversation.is_read|yesno:'true,false' }}"
                         onclick="openConversation('{{ conversation.id }}')">
                        <div class="flex items-start space-x-4">
                            <!-- Avatar -->
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
                                    {% if conversation.sender.profile_picture %}
                                    <img src="{{ conversation.sender.profile_picture.url }}" alt="{{ conversation.sender.get_full_name }}" class="w-10 h-10 rounded-full object-cover">
                                    {% else %}
                                    <span class="text-sm font-medium text-gray-700">{{ conversation.sender.first_name|first }}{{ conversation.sender.last_name|first }}</span>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Contenu -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <p class="text-sm font-medium text-gray-900">
                                            {{ conversation.sender.first_name }} {{ conversation.sender.last_name }}
                                        </p>
                                        {% if conversation.sender_type == 'TEACHER' %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                            Enseignant
                                        </span>
                                        {% elif conversation.sender_type == 'ADMIN' %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                            Administration
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        {% if not conversation.is_read %}
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        {% endif %}
                                        <p class="text-xs text-gray-500">{{ conversation.sent_at|timesince }}</p>
                                    </div>
                                </div>
                                <p class="text-sm font-medium text-gray-900 mt-1">{{ conversation.subject }}</p>
                                <p class="text-sm text-gray-600 mt-1">{{ conversation.content|truncatewords:10 }}</p>
                                {% if conversation.child %}
                                <p class="text-xs text-gray-500 mt-1">Concernant: {{ conversation.child.first_name }} {{ conversation.child.last_name }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="p-6 text-center text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-3.5a2 2 0 00-1.5.5l-2 2a2 2 0 01-1.5.5H9.5a2 2 0 01-1.5-.5l-2-2A2 2 0 004 13m16 0h-3.5"></path>
                    </svg>
                    <p>Aucune conversation pour le moment</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Actions rapides -->
        <div class="space-y-6">
            <!-- Contacts fréquents -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Contacts fréquents</h3>
                {% if frequent_contacts %}
                <div class="space-y-3">
                    {% for contact in frequent_contacts %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                                <span class="text-xs font-medium text-gray-700">{{ contact.first_name|first }}{{ contact.last_name|first }}</span>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ contact.first_name }} {{ contact.last_name }}</p>
                                <p class="text-xs text-gray-600">{{ contact.role }}</p>
                            </div>
                        </div>
                        <button onclick="startConversation('{{ contact.id }}')" 
                                class="text-blue-600 hover:text-blue-900 text-sm">
                            Contacter
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">Aucun contact récent</p>
                {% endif %}
            </div>

            <!-- Prochains rendez-vous -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Prochains rendez-vous</h3>
                {% if upcoming_appointments %}
                <div class="space-y-3">
                    {% for appointment in upcoming_appointments %}
                    <div class="border-l-4 border-blue-500 pl-3">
                        <p class="text-sm font-medium text-gray-900">{{ appointment.title }}</p>
                        <p class="text-xs text-gray-600">{{ appointment.date|date:"d/m/Y" }} à {{ appointment.time|time:"H:i" }}</p>
                        <p class="text-xs text-gray-500">Avec {{ appointment.teacher.first_name }} {{ appointment.teacher.last_name }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">Aucun rendez-vous programmé</p>
                {% endif %}
            </div>

            <!-- Actions rapides -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Actions rapides</h3>
                <div class="space-y-2">
                    <button onclick="requestMeeting()" 
                            class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors text-sm">
                        Demander un rendez-vous
                    </button>
                    <button onclick="reportAbsence()" 
                            class="w-full bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors text-sm">
                        Justifier une absence
                    </button>
                    <button onclick="askQuestion()" 
                            class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                        Poser une question
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de composition de message -->
<div id="composeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideComposeModal()"></div>
        
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Nouveau message</h3>
                        
                        <form id="composeForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Destinataire</label>
                                <select id="recipient" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Sélectionner un destinataire</option>
                                    {% for teacher in teachers %}
                                    <option value="{{ teacher.id }}">{{ teacher.first_name }} {{ teacher.last_name }} ({{ teacher.subjects.first.name }})</option>
                                    {% endfor %}
                                    <option value="admin">Administration</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Enfant concerné</label>
                                <select id="concernedChild" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Aucun enfant spécifique</option>
                                    {% for child in children %}
                                    <option value="{{ child.id }}">{{ child.first_name }} {{ child.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Sujet</label>
                                <input type="text" id="messageSubject" 
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Sujet du message">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Message</label>
                                <textarea id="messageContent" rows="4" 
                                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                          placeholder="Votre message..."></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button onclick="sendMessage()" 
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Envoyer
                </button>
                <button onclick="hideComposeModal()" 
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Annuler
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function showComposeModal() {
    document.getElementById('composeModal').classList.remove('hidden');
}

function hideComposeModal() {
    document.getElementById('composeModal').classList.add('hidden');
    document.getElementById('composeForm').reset();
}

function filterMessages(type) {
    const items = document.querySelectorAll('.conversation-item');
    const buttons = document.querySelectorAll('.filter-btn');
    
    // Reset button styles
    buttons.forEach(btn => {
        btn.classList.remove('active', 'bg-blue-500', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    
    // Activate current button
    const activeBtn = document.getElementById('filter-' + type);
    activeBtn.classList.add('active', 'bg-blue-500', 'text-white');
    activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
    
    // Filter items
    items.forEach(item => {
        const itemType = item.getAttribute('data-type');
        const isRead = item.getAttribute('data-read') === 'true';
        
        let show = false;
        
        switch(type) {
            case 'all':
                show = true;
                break;
            case 'unread':
                show = !isRead;
                break;
            case 'teachers':
                show = itemType === 'TEACHER';
                break;
            case 'admin':
                show = itemType === 'ADMIN';
                break;
        }
        
        item.style.display = show ? 'block' : 'none';
    });
}

function openConversation(conversationId) {
    // Ici, on ouvrirait la conversation détaillée
    console.log('Opening conversation:', conversationId);
    // En attendant, on peut juste marquer comme lu
    // Implémentation future : ouvrir une vue détaillée de la conversation
}

function startConversation(contactId) {
    showComposeModal();
    document.getElementById('recipient').value = contactId;
}

function sendMessage() {
    const recipient = document.getElementById('recipient').value;
    const child = document.getElementById('concernedChild').value;
    const subject = document.getElementById('messageSubject').value;
    const content = document.getElementById('messageContent').value;
    
    if (!recipient || !subject || !content) {
        alert('Veuillez remplir tous les champs obligatoires.');
        return;
    }
    
    // Ici, on enverrait le message via AJAX
    console.log('Sending message:', { recipient, child, subject, content });
    
    // Simuler l'envoi
    alert('Message envoyé avec succès !');
    hideComposeModal();
}

function requestMeeting() {
    // Implémenter la demande de rendez-vous
    alert('Fonctionnalité de demande de rendez-vous à venir');
}

function reportAbsence() {
    // Implémenter la justification d'absence
    alert('Fonctionnalité de justification d\'absence à venir');
}

function askQuestion() {
    showComposeModal();
    document.getElementById('messageSubject').value = 'Question générale';
}

// Auto-refresh conversations every 30 seconds
setInterval(() => {
    console.log('Checking for new messages...');
    // Ici, on ferait un appel AJAX pour vérifier les nouveaux messages
}, 30000);
</script>
{% endblock %}
