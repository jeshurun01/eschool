{% extends 'base.html' %}
{% load static %}

{% block title %}Créer une Année Scolaire - eSchool{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- En-tête -->
        <div class="mb-8">
            <nav class="flex mb-4" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <a href="{% url 'academic:academic_year_list' %}" class="text-gray-700 hover:text-blue-600 flex items-center">
                            <span class="material-icons mr-2 text-sm">event</span>Années scolaires
                        </a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <span class="material-icons text-gray-400 mx-2 text-sm">chevron_right</span>
                            <span class="text-gray-500">Créer une année</span>
                        </div>
                    </li>
                </ol>
            </nav>
            <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                <span class="material-icons mr-3 text-green-600">add_circle</span>
                Créer une nouvelle année scolaire
            </h1>
        </div>

        <!-- Formulaire -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Informations de l'année scolaire</h2>
            </div>
            
            <form method="post" class="px-6 py-6 space-y-6">
                {% csrf_token %}
                
                <!-- Nom de l'année -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                        Nom de l'année scolaire <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           id="name" 
                           name="name" 
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500"
                           placeholder="Ex: 2024-2025, Année scolaire 2024/2025...">
                    <p class="mt-1 text-sm text-gray-500">
                        Nom descriptif de l'année scolaire
                    </p>
                </div>
                
                <!-- Dates -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Date de début -->
                    <div>
                        <label for="start_date" class="block text-sm font-medium text-gray-700 mb-2">
                            Date de début <span class="text-red-500">*</span>
                        </label>
                        <input type="date" 
                               id="start_date" 
                               name="start_date" 
                               required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        <p class="mt-1 text-sm text-gray-500">
                            Premier jour de l'année scolaire
                        </p>
                    </div>
                    
                    <!-- Date de fin -->
                    <div>
                        <label for="end_date" class="block text-sm font-medium text-gray-700 mb-2">
                            Date de fin <span class="text-red-500">*</span>
                        </label>
                        <input type="date" 
                               id="end_date" 
                               name="end_date" 
                               required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        <p class="mt-1 text-sm text-gray-500">
                            Dernier jour de l'année scolaire
                        </p>
                    </div>
                </div>
                
                <!-- Année courante -->
                <div class="flex items-center">
                    <input type="checkbox" 
                           id="is_current" 
                           name="is_current"
                           class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                    <label for="is_current" class="ml-2 block text-sm text-gray-900">
                        Marquer comme année courante
                    </label>
                </div>
                <p class="text-sm text-gray-500 ml-6">
                    <span class="material-icons text-xs mr-1">info</span>
                    Si activé, cette année deviendra l'année académique active (les autres seront automatiquement désactivées)
                </p>
                
                <!-- Informations supplémentaires -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <span class="material-icons text-green-400">info</span>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-green-800">
                                Informations importantes
                            </h3>
                            <div class="mt-2 text-sm text-green-700">
                                <ul class="list-disc pl-5 space-y-1">
                                    <li>Une seule année peut être marquée comme "courante" à la fois</li>
                                    <li>L'année courante sera utilisée par défaut pour les nouvelles classes</li>
                                    <li>Vous pourrez modifier ces informations ultérieurement</li>
                                    <li>La date de fin doit être postérieure à la date de début</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                    {% if not is_popup %}
                    <a href="{% url 'academic:academic_year_list' %}" 
                       class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center">
                        <span class="material-icons mr-2 text-sm">cancel</span>
                        Annuler
                    </a>
                    {% else %}
                    <button type="button" 
                            onclick="window.close()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center">
                        <span class="material-icons mr-2 text-sm">close</span>
                        Fermer
                    </button>
                    {% endif %}
                    <button type="submit"
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center">
                        <span class="material-icons mr-2 text-sm">save</span>
                        Créer l'année
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validation côté client
    const form = document.querySelector('form');
    const nameInput = document.getElementById('name');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    // Définir les dates par défaut
    const today = new Date();
    const currentYear = today.getFullYear();
    const nextYear = currentYear + 1;
    
    // Si septembre ou plus tard, suggérer l'année courante comme début
    // Sinon, suggérer l'année précédente
    const startYear = today.getMonth() >= 8 ? currentYear : currentYear - 1; // 8 = septembre (0-indexé)
    const endYear = startYear + 1;
    
    if (!startDateInput.value) {
        startDateInput.value = `${startYear}-09-01`; // 1er septembre
    }
    if (!endDateInput.value) {
        endDateInput.value = `${endYear}-07-31`; // 31 juillet
    }
    if (!nameInput.value) {
        nameInput.value = `${startYear}-${endYear}`;
    }
    
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // Vérifier les champs obligatoires
        if (!nameInput.value.trim()) {
            isValid = false;
            nameInput.classList.add('border-red-500');
        } else {
            nameInput.classList.remove('border-red-500');
        }
        
        if (!startDateInput.value) {
            isValid = false;
            startDateInput.classList.add('border-red-500');
        } else {
            startDateInput.classList.remove('border-red-500');
        }
        
        if (!endDateInput.value) {
            isValid = false;
            endDateInput.classList.add('border-red-500');
        } else {
            endDateInput.classList.remove('border-red-500');
        }
        
        // Vérifier que la date de fin est après la date de début
        if (startDateInput.value && endDateInput.value) {
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            if (endDate <= startDate) {
                isValid = false;
                endDateInput.classList.add('border-red-500');
                alert('La date de fin doit être postérieure à la date de début.');
            } else {
                endDateInput.classList.remove('border-red-500');
            }
        }
        
        if (!isValid) {
            e.preventDefault();
            if (!startDateInput.value || !endDateInput.value || !nameInput.value.trim()) {
                alert('Veuillez remplir tous les champs obligatoires.');
            }
        }
    });
    
    // Retirer la bordure rouge quand l'utilisateur commence à taper
    [nameInput, startDateInput, endDateInput].forEach(input => {
        input.addEventListener('change', function() {
            this.classList.remove('border-red-500');
        });
    });
    
    // Mise à jour automatique du nom basé sur les dates
    function updateNameFromDates() {
        if (startDateInput.value && endDateInput.value && !nameInput.value.trim()) {
            const startYear = new Date(startDateInput.value).getFullYear();
            const endYear = new Date(endDateInput.value).getFullYear();
            nameInput.value = `${startYear}-${endYear}`;
        }
    }
    
    startDateInput.addEventListener('change', updateNameFromDates);
    endDateInput.addEventListener('change', updateNameFromDates);
});
</script>
{% endblock %}