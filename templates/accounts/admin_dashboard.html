{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard Administrateur - {{ block.super }}{% endblock %}


{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                        <span class="material-icons text-blue-600 mr-3 text-4xl">dashboard</span>
                        Dashboard Administrateur
                    </h1>
                    <p class="mt-1 text-sm text-gray-600">Vue d'ensemble complète de l'école - {{ today|date:"l d F Y" }}</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center bg-blue-50 px-4 py-2 rounded-lg">
                        <span class="material-icons text-blue-600 mr-2">admin_panel_settings</span>
                        <div>
                            <span class="text-sm text-gray-500 block">Connecté en tant que</span>
                            <span class="font-medium text-blue-600">{{ user.get_full_name }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Statistiques principales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Élèves -->
            <div class="bg-white overflow-hidden shadow-lg rounded-xl border border-gray-100 hover:shadow-xl transition-shadow duration-300">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                                <span class="material-icons text-white text-2xl">school</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Total Élèves</dt>
                                <dd class="text-2xl font-bold text-gray-900">{{ stats.total_students }}</dd>
                                <dd class="text-xs text-green-600 font-medium">+12% ce mois</dd>
                            </dl>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="{% url 'accounts:student_list' %}" class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center">
                            Voir tous les élèves
                            <span class="material-icons ml-1 text-sm">arrow_forward</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Total Enseignants -->
            <div class="bg-white overflow-hidden shadow-lg rounded-xl border border-gray-100 hover:shadow-xl transition-shadow duration-300">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                                <span class="material-icons text-white text-2xl">person</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Enseignants</dt>
                                <dd class="text-2xl font-bold text-gray-900">{{ stats.total_teachers }}</dd>
                                <dd class="text-xs text-blue-600 font-medium">{{ stats.total_parents }} parents</dd>
                            </dl>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="{% url 'accounts:teacher_list' %}" class="text-green-600 hover:text-green-700 text-sm font-medium flex items-center">
                            Gérer le personnel
                            <span class="material-icons ml-1 text-sm">arrow_forward</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Total Classes -->
            <div class="bg-white overflow-hidden shadow-lg rounded-xl border border-gray-100 hover:shadow-xl transition-shadow duration-300">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl flex items-center justify-center shadow-lg">
                                <span class="material-icons text-white text-2xl">class</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Classes</dt>
                                <dd class="text-2xl font-bold text-gray-900">{{ stats.total_classes }}</dd>
                                <dd class="text-xs text-gray-600 font-medium">{{ stats.total_subjects }} matières</dd>
                            </dl>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="/admin/academic/classroom/" class="text-yellow-600 hover:text-yellow-700 text-sm font-medium flex items-center">
                            Voir les classes
                            <span class="material-icons ml-1 text-sm">arrow_forward</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Revenus du mois -->
            <div class="bg-white overflow-hidden shadow-lg rounded-xl border border-gray-100 hover:shadow-xl transition-shadow duration-300">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                                <span class="material-icons text-white text-2xl">payments</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Revenus (mois)</dt>
                                <dd class="text-2xl font-bold text-gray-900">${{ stats.month_revenue|floatformat:0 }}</dd>
                                <dd class="text-xs text-green-600 font-medium">Total: ${{ stats.total_revenue|floatformat:0 }}</dd>
                            </dl>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="{% url 'finance:payment_list' %}" class="text-purple-600 hover:text-purple-700 text-sm font-medium flex items-center">
                            Rapport finance
                            <span class="material-icons ml-1 text-sm">arrow_forward</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deuxième ligne de statistiques détaillées -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Présences du jour -->
            <div class="bg-white overflow-hidden shadow-lg rounded-xl border border-gray-100">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <span class="material-icons text-green-600 mr-2">how_to_reg</span>
                        <h3 class="text-sm font-medium text-gray-500">Présences aujourd'hui</h3>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 mb-2">{{ stats.today_attendances }}</div>
                    <div class="flex items-center text-sm">
                        <span class="material-icons text-red-500 mr-1 text-sm">person_off</span>
                        <span class="text-red-600">{{ stats.today_absences }} absence{{ stats.today_absences|pluralize }}</span>
                    </div>
                </div>
            </div>

            <!-- Factures en attente -->
            <div class="bg-white overflow-hidden shadow-lg rounded-xl border border-gray-100">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <span class="material-icons text-orange-600 mr-2">receipt_long</span>
                        <h3 class="text-sm font-medium text-gray-500">Factures en attente</h3>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 mb-2">{{ stats.pending_invoices }}</div>
                    <div class="flex items-center text-sm">
                        <span class="material-icons text-gray-500 mr-1 text-sm">receipt</span>
                        <span class="text-gray-600">sur {{ stats.total_invoices }} au total</span>
                    </div>
                </div>
            </div>

            <!-- Inscriptions actives -->
            <div class="bg-white overflow-hidden shadow-lg rounded-xl border border-gray-100">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <span class="material-icons text-blue-600 mr-2">how_to_reg</span>
                        <h3 class="text-sm font-medium text-gray-500">Inscriptions actives</h3>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 mb-2">{{ stats.active_enrollments }}</div>
                    <div class="flex items-center text-sm">
                        <span class="material-icons text-green-500 mr-1 text-sm">groups</span>
                        <span class="text-green-600">Moyenne: {{ academic_stats.avg_class_size|floatformat:1 }} élèves/classe</span>
                    </div>
                </div>
            </div>

            <!-- Utilisateurs actifs -->
            <div class="bg-white overflow-hidden shadow-lg rounded-xl border border-gray-100">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <span class="material-icons text-indigo-600 mr-2">people</span>
                        <h3 class="text-sm font-medium text-gray-500">Utilisateurs actifs</h3>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 mb-2">{{ stats.total_users }}</div>
                    <div class="flex items-center text-sm">
                        <span class="material-icons text-green-500 mr-1 text-sm">verified_user</span>
                        <span class="text-green-600">Tous vérifiés</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation rapide améliorée -->
        <div class="bg-white shadow-lg rounded-xl mb-8 border border-gray-100">
            <div class="px-6 py-5">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-6 flex items-center">
                    <span class="material-icons text-blue-600 mr-2">flash_on</span>
                    Actions rapides
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <a href="{% url 'accounts:register' %}" class="group inline-flex items-center px-6 py-3 border border-gray-200 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-blue-50 hover:border-blue-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200">
                        <span class="material-icons mr-3 text-blue-600 group-hover:text-blue-700">person_add</span>
                        <div>
                            <div class="font-medium">Nouvel utilisateur</div>
                            <div class="text-xs text-gray-500">Élève, enseignant, parent</div>
                        </div>
                    </a>
                    
                    <a href="{% url 'academic:classroom_create' %}" class="group inline-flex items-center px-6 py-3 border border-gray-200 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-green-50 hover:border-green-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200">
                        <span class="material-icons mr-3 text-green-600 group-hover:text-green-700">add_business</span>
                        <div>
                            <div class="font-medium">Nouvelle classe</div>
                            <div class="text-xs text-gray-500">Créer une nouvelle classe</div>
                        </div>
                    </a>
                    
                    <a href="{% url 'finance:invoice_create' %}" class="group inline-flex items-center px-6 py-3 border border-gray-200 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-yellow-50 hover:border-yellow-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-all duration-200">
                        <span class="material-icons mr-3 text-yellow-600 group-hover:text-yellow-700">receipt_long</span>
                        <div>
                            <div class="font-medium">Nouvelle facture</div>
                            <div class="text-xs text-gray-500">Créer une facture</div>
                        </div>
                    </a>
                    
                    <a href="{% url 'communication:announcement_create' %}" class="group inline-flex items-center px-6 py-3 border border-gray-200 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-purple-50 hover:border-purple-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200">
                        <span class="material-icons mr-3 text-purple-600 group-hover:text-purple-700">campaign</span>
                        <div>
                            <div class="font-medium">Nouvelle annonce</div>
                            <div class="text-xs text-gray-500">Informer la communauté</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- Modules et gestion -->
        <div class="bg-white shadow-lg rounded-xl mb-8 border border-gray-100">
            <div class="px-6 py-5">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-6 flex items-center">
                    <span class="material-icons text-indigo-600 mr-2">apps</span>
                    Modules et gestion
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Module Académique -->
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-center mb-3">
                            <span class="material-icons text-blue-600 mr-2 text-2xl">school</span>
                            <h4 class="font-medium text-gray-900">Module Académique</h4>
                        </div>
                        <div class="space-y-2">
                            <a href="{% url 'academic:level_list' %}" class="block text-sm text-blue-600 hover:text-blue-700 flex items-center">
                                <span class="material-icons mr-1 text-sm">grade</span>
                                Niveaux scolaires
                            </a>
                            <a href="{% url 'academic:classroom_list' %}" class="block text-sm text-blue-600 hover:text-blue-700 flex items-center">
                                <span class="material-icons mr-1 text-sm">meeting_room</span>
                                Classes
                            </a>
                            <a href="{% url 'academic:subject_list' %}" class="block text-sm text-blue-600 hover:text-blue-700 flex items-center">
                                <span class="material-icons mr-1 text-sm">menu_book</span>
                                Matières
                            </a>
                            <a href="{% url 'academic:grade_list' %}" class="block text-sm text-blue-600 hover:text-blue-700 flex items-center">
                                <span class="material-icons mr-1 text-sm">how_to_reg</span>
                                Notes
                            </a>
                        </div>
                    </div>

                    <!-- Module Finance -->
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-center mb-3">
                            <span class="material-icons text-green-600 mr-2 text-2xl">account_balance</span>
                            <h4 class="font-medium text-gray-900">Module Finance</h4>
                        </div>
                        <div class="space-y-2">
                            <a href="{% url 'finance:fee_structure_list' %}" class="block text-sm text-green-600 hover:text-green-700 flex items-center">
                                <span class="material-icons mr-1 text-sm">price_check</span>
                                Tarifs
                            </a>
                            <a href="{% url 'finance:invoice_list' %}" class="block text-sm text-green-600 hover:text-green-700 flex items-center">
                                <span class="material-icons mr-1 text-sm">receipt</span>
                                Factures
                            </a>
                            <a href="{% url 'finance:payment_list' %}" class="block text-sm text-green-600 hover:text-green-700 flex items-center">
                                <span class="material-icons mr-1 text-sm">payment</span>
                                Paiements
                            </a>
                            <a href="{% url 'finance:financial_reports' %}" class="block text-sm text-green-600 hover:text-green-700 flex items-center">
                                <span class="material-icons mr-1 text-sm">analytics</span>
                                Rapports
                            </a>
                        </div>
                    </div>

                    <!-- Module Communication -->
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-center mb-3">
                            <span class="material-icons text-purple-600 mr-2 text-2xl">forum</span>
                            <h4 class="font-medium text-gray-900">Communication</h4>
                        </div>
                        <div class="space-y-2">
                            <a href="{% url 'communication:announcement_list' %}" class="block text-sm text-purple-600 hover:text-purple-700 flex items-center">
                                <span class="material-icons mr-1 text-sm">campaign</span>
                                Annonces
                            </a>
                            <a href="{% url 'communication:message_list' %}" class="block text-sm text-purple-600 hover:text-purple-700 flex items-center">
                                <span class="material-icons mr-1 text-sm">mail</span>
                                Messages
                            </a>
                            <a href="{% url 'communication:resource_list' %}" class="block text-sm text-purple-600 hover:text-purple-700 flex items-center">
                                <span class="material-icons mr-1 text-sm">folder</span>
                                Ressources
                            </a>
                            <a href="{% url 'communication:notification_list' %}" class="block text-sm text-purple-600 hover:text-purple-700 flex items-center">
                                <span class="material-icons mr-1 text-sm">notifications</span>
                                Notifications
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activité récente et tableaux détaillés -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Nouveaux élèves -->
            <div class="bg-white shadow-lg rounded-xl border border-gray-100">
                <div class="px-6 py-5">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4 flex items-center">
                        <span class="material-icons text-blue-600 mr-2">person_add</span>
                        Nouveaux élèves (7 derniers jours)
                    </h3>
                    {% if recent_activity.new_students %}
                        <div class="space-y-4">
                            {% for student in recent_activity.new_students %}
                            <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-b-0">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-12 w-12">
                                        {% if student.user.avatar %}
                                            <img class="h-12 w-12 rounded-full object-cover border-2 border-blue-100" src="{{ student.user.avatar.url }}" alt="">
                                        {% else %}
                                            <div class="h-12 w-12 rounded-full bg-gradient-to-r from-blue-400 to-blue-600 flex items-center justify-center border-2 border-blue-100">
                                                <span class="text-white font-semibold">{{ student.user.first_name|first }}{{ student.user.last_name|first }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">{{ student.user.get_full_name }}</div>
                                        <div class="text-sm text-gray-500 flex items-center">
                                            <span class="material-icons mr-1 text-xs">badge</span>
                                            {{ student.matricule }}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-500">{{ student.user.date_joined|date:"d/m" }}</div>
                                    <div class="text-xs text-blue-600">Nouveau</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mt-4">
                            <a href="{% url 'accounts:student_list' %}" class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center">
                                Voir tous les élèves
                                <span class="material-icons ml-1 text-sm">arrow_forward</span>
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-6">
                            <span class="material-icons text-gray-400 text-4xl mb-2">person_outline</span>
                            <p class="text-gray-500 text-sm">Aucun nouvel élève cette semaine.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Paiements récents -->
            <div class="bg-white shadow-lg rounded-xl border border-gray-100">
                <div class="px-6 py-5">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4 flex items-center">
                        <span class="material-icons text-green-600 mr-2">payment</span>
                        Paiements récents
                    </h3>
                    {% if recent_activity.recent_payments %}
                        <div class="space-y-4">
                            {% for payment in recent_activity.recent_payments %}
                            <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-b-0">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-10 h-10 bg-gradient-to-r from-green-400 to-green-600 rounded-lg flex items-center justify-center">
                                            <span class="material-icons text-white text-sm">attach_money</span>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">${{ payment.amount }}</div>
                                        <div class="text-sm text-gray-500 flex items-center">
                                            <span class="material-icons mr-1 text-xs">credit_card</span>
                                            {{ payment.method }}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-500">{{ payment.payment_date|date:"d/m" }}</div>
                                    <div class="text-xs text-green-600">Complété</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mt-4">
                            <a href="/admin/finance/payment/" class="text-green-600 hover:text-green-700 text-sm font-medium flex items-center">
                                Voir tous les paiements
                                <span class="material-icons ml-1 text-sm">arrow_forward</span>
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-6">
                            <span class="material-icons text-gray-400 text-4xl mb-2">payment</span>
                            <p class="text-gray-500 text-sm">Aucun paiement récent.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Liens administration directs -->
        <div class="bg-white shadow-lg rounded-xl border border-gray-100 mb-8">
            <div class="px-6 py-5">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-6 flex items-center">
                    <span class="material-icons text-red-600 mr-2">admin_panel_settings</span>
                    Administration avancée
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <a href="/admin/" class="group flex items-center p-4 border border-gray-200 rounded-lg hover:bg-red-50 hover:border-red-300 transition-all duration-200">
                        <span class="material-icons text-red-600 mr-3 group-hover:text-red-700">settings</span>
                        <div>
                            <div class="font-medium text-gray-900">Interface Admin</div>
                            <div class="text-xs text-gray-500">Administration complète</div>
                        </div>
                    </a>
                    
                    <a href="/admin/auth/user/" class="group flex items-center p-4 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-all duration-200">
                        <span class="material-icons text-blue-600 mr-3 group-hover:text-blue-700">people</span>
                        <div>
                            <div class="font-medium text-gray-900">Gestion utilisateurs</div>
                            <div class="text-xs text-gray-500">Comptes et permissions</div>
                        </div>
                    </a>
                    
                    <a href="/admin/auth/group/" class="group flex items-center p-4 border border-gray-200 rounded-lg hover:bg-green-50 hover:border-green-300 transition-all duration-200">
                        <span class="material-icons text-green-600 mr-3 group-hover:text-green-700">groups</span>
                        <div>
                            <div class="font-medium text-gray-900">Groupes</div>
                            <div class="text-xs text-gray-500">Rôles et permissions</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
