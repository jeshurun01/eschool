{% extends 'base.html' %}
{% load static %}

{% block title %}Bulletin par P√©riodes - eSchool{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .no-print { display: none; }
        body { background: white; }
    }
    
    .period-card {
        page-break-inside: avoid;
    }
    
    /* Codes couleur am√©lior√©s pour les appr√©ciations */
    .appreciation-excellent { 
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    .appreciation-tres-bien { 
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    
    .appreciation-bien { 
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }
    
    .appreciation-assez-bien { 
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    
    .appreciation-insuffisant { 
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    
    /* Styles pour les moyennes dans les cellules */
    .moyenne-excellent { color: #059669; font-weight: 700; }
    .moyenne-tres-bien { color: #2563eb; font-weight: 700; }
    .moyenne-bien { color: #7c3aed; font-weight: 700; }
    .moyenne-assez-bien { color: #d97706; font-weight: 700; }
    .moyenne-insuffisant { color: #dc2626; font-weight: 700; }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold flex items-center">
                            <span class="material-icons mr-3 text-4xl">summarize</span>
                            Bulletin par P√©riodes
                        </h1>
                        <p class="mt-2 text-indigo-100">{{ student.user.get_full_name }} ‚Ä¢ {{ student.current_class.name }}{% if current_year %} ‚Ä¢ {{ current_year.name }}{% endif %}</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        {% if all_years %}
                        <!-- S√©lecteur d'ann√©e -->
                        <div class="bg-white/10 rounded-lg px-4 py-2">
                            <label class="text-sm text-indigo-200 block mb-1">Ann√©e acad√©mique</label>
                            <select onchange="window.location.href='?year=' + this.value" 
                                    class="bg-white text-gray-900 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300">
                                {% for year in all_years %}
                                <option value="{{ year.id }}" {% if current_year and year.id == current_year.id %}selected{% endif %}>
                                    {{ year.name }}{% if year.is_current %} (Actuelle){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        
                        {% if has_any_data %}
                        <div class="text-right bg-white/10 rounded-lg px-6 py-4">
                            <div class="text-4xl font-bold">{{ annual_average }}/20</div>
                            <div class="text-sm text-indigo-200">Moyenne Annuelle</div>
                        </div>
                        <button onclick="window.print()" 
                                class="inline-flex items-center px-6 py-3 bg-white text-indigo-600 rounded-lg shadow-lg hover:bg-indigo-50 transition-colors font-medium">
                            <span class="material-icons mr-2">print</span>
                            Imprimer
                        </button>
                        {% endif %}
                        
                        <a href="{% url 'accounts:student_grades_detail' %}" 
                           class="inline-flex items-center px-6 py-3 bg-indigo-700 text-white rounded-lg hover:bg-indigo-800 transition-colors font-medium">
                            <span class="material-icons mr-2">arrow_back</span>
                            Retour
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% if no_data or not has_any_data %}
        <!-- Aucune donn√©e pour cette ann√©e -->
        <div class="bg-white rounded-lg shadow-sm p-12 text-center">
            <span class="material-icons text-gray-400 text-6xl mb-4">assignment</span>
            <h3 class="text-xl font-medium text-gray-900 mb-2">Aucune note disponible{% if current_year %} pour {{ current_year.name }}{% endif %}</h3>
            <p class="text-gray-500 mb-4">Les notes seront affich√©es ici une fois qu'elles seront saisies par vos enseignants.</p>
            {% if all_years.count > 1 %}
            <p class="text-sm text-gray-600">üí° Vous pouvez s√©lectionner une autre ann√©e acad√©mique ci-dessus.</p>
            {% endif %}
            <div class="mt-6">
                <a href="{% url 'accounts:student_grades_detail' %}" 
                   class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                    <span class="material-icons mr-2">arrow_back</span>
                    Voir les notes d√©taill√©es
                </a>
            </div>
        </div>
        
        {% elif not report_data %}
        <!-- Aucune p√©riode configur√©e -->
        <div class="bg-yellow-50 rounded-lg border-2 border-yellow-200 p-8 text-center">
            <span class="material-icons text-yellow-600 text-6xl mb-4">warning</span>
            <h3 class="text-xl font-medium text-yellow-900 mb-2">Configuration incompl√®te</h3>
            <p class="text-yellow-700 mb-4">Aucune p√©riode d'√©valuation n'a √©t√© configur√©e pour cette ann√©e acad√©mique.</p>
            <p class="text-sm text-yellow-600">Contactez l'administration pour qu'elle configure les p√©riodes (trimestres, semestres, etc.).</p>
        </div>
        
        {% else %}
        
        <!-- Vue d'ensemble des p√©riodes -->
        <div class="grid grid-cols-1 md:grid-cols-{{ report_data|length }} gap-4 mb-8 no-print">
            {% for period_info in report_data %}
            <div class="bg-white rounded-lg shadow-sm p-6 text-center border-2 {% if period_info.period.is_current %}border-indigo-500{% else %}border-transparent{% endif %}">
                <div class="text-sm font-medium text-gray-500 mb-2">{{ period_info.period.name }}</div>
                <div class="text-3xl {% if period_info.period_average >= 16 %}moyenne-excellent{% elif period_info.period_average >= 14 %}moyenne-tres-bien{% elif period_info.period_average >= 12 %}moyenne-bien{% elif period_info.period_average >= 10 %}moyenne-assez-bien{% else %}moyenne-insuffisant{% endif %}">
                    {{ period_info.period_average }}/20
                </div>
                <div class="mt-3">
                    <span class="px-3 py-1 inline-flex items-center text-xs font-bold rounded-lg {% if period_info.period_average >= 16 %}appreciation-excellent{% elif period_info.period_average >= 14 %}appreciation-tres-bien{% elif period_info.period_average >= 12 %}appreciation-bien{% elif period_info.period_average >= 10 %}appreciation-assez-bien{% else %}appreciation-insuffisant{% endif %}">
                        {% if period_info.period_average >= 16 %}
                            <span class="material-icons text-xs mr-1">star</span>
                            Excellent
                        {% elif period_info.period_average >= 14 %}
                            <span class="material-icons text-xs mr-1">thumb_up</span>
                            Tr√®s Bien
                        {% elif period_info.period_average >= 12 %}
                            <span class="material-icons text-xs mr-1">sentiment_satisfied</span>
                            Bien
                        {% elif period_info.period_average >= 10 %}
                            <span class="material-icons text-xs mr-1">sentiment_neutral</span>
                            Assez Bien
                        {% else %}
                            <span class="material-icons text-xs mr-1">trending_down</span>
                            Insuffisant
                        {% endif %}
                    </span>
                </div>
                <div class="text-xs text-gray-500 mt-2">{{ period_info.total_subjects }} mati√®res</div>
                {% if period_info.period.is_current %}
                <div class="mt-2">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                        En cours
                    </span>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- D√©tails par p√©riode -->
        {% for period_info in report_data %}
        <div class="period-card bg-white rounded-lg shadow-lg mb-8 overflow-hidden">
            <!-- En-t√™te de p√©riode -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold">{{ period_info.period.name }}</h2>
                        <p class="text-indigo-100">{{ period_info.period.start_date|date:"d/m/Y" }} - {{ period_info.period.end_date|date:"d/m/Y" }}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-bold">{{ period_info.period_average }}/20</div>
                        <div class="text-sm text-indigo-200">Moyenne de p√©riode</div>
                    </div>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="grid grid-cols-3 gap-4 p-6 bg-gray-50 border-b">
                <div class="text-center">
                    <div class="text-2xl font-bold text-indigo-600">{{ period_info.total_subjects }}</div>
                    <div class="text-sm text-gray-600">Mati√®res</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600">{{ period_info.total_evaluations }}</div>
                    <div class="text-sm text-gray-600">√âvaluations</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold {% if period_info.period_average >= 12 %}text-green-600{% elif period_info.period_average >= 10 %}text-yellow-600{% else %}text-red-600{% endif %}">
                        {{ period_info.period_average|floatformat:1 }}%
                    </div>
                    <div class="text-sm text-gray-600">Pourcentage</div>
                </div>
            </div>

            {% if period_info.subjects %}
            <!-- Tableau des mati√®res -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Mati√®re
                            </th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Nombre d'√©val.
                            </th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Coefficient
                            </th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Moyenne
                            </th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Appr√©ciation
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for subject_name, subject_data in period_info.subjects.items %}
                        <tr class="hover:bg-gray-50 cursor-pointer" onclick="toggleDetails('{{ period_info.period.id }}_{{ subject_data.subject.id }}')">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <span class="material-icons text-indigo-600 mr-2">menu_book</span>
                                    <div class="font-medium text-gray-900">{{ subject_name }}</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                                {{ subject_data.total_grades }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                                {{ subject_data.coefficient }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <span class="text-lg {% if subject_data.average >= 16 %}moyenne-excellent{% elif subject_data.average >= 14 %}moyenne-tres-bien{% elif subject_data.average >= 12 %}moyenne-bien{% elif subject_data.average >= 10 %}moyenne-assez-bien{% else %}moyenne-insuffisant{% endif %}">
                                    {{ subject_data.average }}/20
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <span class="px-4 py-2 inline-flex text-xs leading-5 font-bold rounded-lg {% if subject_data.average >= 16 %}appreciation-excellent{% elif subject_data.average >= 14 %}appreciation-tres-bien{% elif subject_data.average >= 12 %}appreciation-bien{% elif subject_data.average >= 10 %}appreciation-assez-bien{% else %}appreciation-insuffisant{% endif %}">
                                    {% if subject_data.average >= 16 %}
                                        <span class="material-icons text-sm mr-1">star</span>
                                        Excellent
                                    {% elif subject_data.average >= 14 %}
                                        <span class="material-icons text-sm mr-1">thumb_up</span>
                                        Tr√®s Bien
                                    {% elif subject_data.average >= 12 %}
                                        <span class="material-icons text-sm mr-1">sentiment_satisfied</span>
                                        Bien
                                    {% elif subject_data.average >= 10 %}
                                        <span class="material-icons text-sm mr-1">sentiment_neutral</span>
                                        Assez Bien
                                    {% else %}
                                        <span class="material-icons text-sm mr-1">trending_down</span>
                                        Insuffisant
                                    {% endif %}
                                </span>
                            </td>
                        </tr>
                        <!-- D√©tails des notes (masqu√© par d√©faut) -->
                        <tr id="details_{{ period_info.period.id }}_{{ subject_data.subject.id }}" class="hidden bg-gray-50">
                            <td colspan="5" class="px-6 py-4">
                                <div class="space-y-2">
                                    <h4 class="font-medium text-gray-900 mb-3">D√©tail des √©valuations :</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        {% for grade in subject_data.grades %}
                                        <div class="bg-white border-2 rounded-lg p-3 hover:shadow-md transition-shadow {% if grade.score >= 16 %}border-green-200{% elif grade.score >= 14 %}border-blue-200{% elif grade.score >= 12 %}border-purple-200{% elif grade.score >= 10 %}border-orange-200{% else %}border-red-200{% endif %}">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-xs font-medium text-gray-500">{{ grade.type }}</span>
                                                <span class="text-xs text-gray-400">{{ grade.date|date:"d/m" }}</span>
                                            </div>
                                            <div class="font-medium text-gray-900 mb-2">{{ grade.name }}</div>
                                            <div class="flex items-center justify-between">
                                                <span class="text-lg {% if grade.score >= 16 %}moyenne-excellent{% elif grade.score >= 14 %}moyenne-tres-bien{% elif grade.score >= 12 %}moyenne-bien{% elif grade.score >= 10 %}moyenne-assez-bien{% else %}moyenne-insuffisant{% endif %}">
                                                    {{ grade.score }}/{{ grade.max_score }}
                                                </span>
                                                <span class="text-xs font-medium px-2 py-1 bg-gray-100 rounded text-gray-600">
                                                    <span class="material-icons text-xs align-middle">speed</span>
                                                    {{ grade.coefficient }}
                                                </span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-8 text-center text-gray-500">
                <span class="material-icons text-4xl mb-2">assignment_late</span>
                <p>Aucune note pour cette p√©riode</p>
            </div>
            {% endif %}
            
            <!-- Section des mati√®res sans notes -->
            {% if period_info.subjects_without_grades %}
            <div class="bg-gray-50 border-t border-gray-200 overflow-hidden">
                <div class="px-6 py-4 bg-gray-100 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h4 class="text-sm font-medium text-gray-700 flex items-center">
                            <span class="material-icons text-sm mr-2">info</span>
                            Mati√®res non encore √©valu√©es
                            <span class="ml-2 px-2 py-1 text-xs bg-gray-200 text-gray-600 rounded-full">{{ period_info.total_subjects_without_grades }}</span>
                        </h4>
                    </div>
                </div>
                <div class="px-6 py-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        {% for subject_info in period_info.subjects_without_grades %}
                        <div class="bg-white border border-gray-200 rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">{{ subject_info.name }}</div>
                                    <div class="text-xs text-gray-500 mt-1">Code: {{ subject_info.code }}</div>
                                </div>
                                <div class="text-right ml-3">
                                    <div class="text-xs text-gray-500">Coef.</div>
                                    <div class="text-sm font-medium text-gray-700">{{ subject_info.coefficient }}</div>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-100">
                                <div class="flex items-center text-xs text-gray-500">
                                    <span class="material-icons text-sm mr-1">pending</span>
                                    Pas encore √©valu√©
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>

<script>
function toggleDetails(id) {
    const element = document.getElementById('details_' + id);
    if (element) {
        element.classList.toggle('hidden');
    }
}
</script>
{% endblock %}
