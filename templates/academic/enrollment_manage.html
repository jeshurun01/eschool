{% extends "base.html" %}
{% load static %}

{% block title %}Gestion des Inscriptions - {{ classroom.name }}{% endblock %}

{% block extra_css %}
<style>
    .student-card {
        transition: all 0.3s ease;
    }
    .student-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .action-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <nav class="flex items-center space-x-2 text-sm text-gray-600 mb-4">
                    <a href="{% url 'academic:classroom_list' %}" class="hover:text-blue-600">
                        <span class="material-icons text-sm mr-1">class</span>Classes
                    </a>
                    <span>/</span>
                    <a href="{% url 'academic:classroom_detail' classroom.id %}" class="hover:text-blue-600">{{ classroom.name }}</a>
                    <span>/</span>
                    <span class="text-gray-900">
                        <span class="material-icons text-sm mr-1">group</span>Gestion des Inscriptions
                    </span>
                </nav>
                
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <span class="material-icons text-3xl mr-2 align-middle">group</span>Gestion des Inscriptions
                </h1>
                <p class="text-gray-600">{{ classroom.name }} - {{ classroom.grade.name }}</p>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stats-card rounded-lg shadow-lg p-6 text-center">
                <div class="text-4xl mb-2">
                    <span class="material-icons text-4xl">school</span>
                </div>
                <div class="text-3xl font-bold">{{ enrollments.count }}</div>
                <div class="text-sm opacity-90">√âtudiants inscrits</div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 text-center border-l-4 border-green-500">
                <div class="text-4xl mb-2 text-green-600">
                    <span class="material-icons text-4xl">groups</span>
                </div>
                <div class="text-3xl font-bold text-gray-900">{{ classroom.capacity|default:"‚àû" }}</div>
                <div class="text-sm text-gray-600">Capacit√© maximale</div>
            </div>
            
            <div class="action-card rounded-lg shadow-lg p-6 text-center">
                <div class="text-4xl mb-2">
                    <span class="material-icons text-4xl">analytics</span>
                </div>
                <div class="text-3xl font-bold">
                    {% if classroom.capacity %}
                        {{ enrollments.count }}/{{ classroom.capacity }}
                    {% else %}
                        {{ enrollments.count }}
                    {% endif %}
                </div>
                <div class="text-sm opacity-90">Taux d'occupation</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Students currently enrolled -->
            <div class="bg-white rounded-lg shadow-lg">
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-lg">
                    <h2 class="text-xl font-bold flex items-center">
                        <span class="material-icons mr-2">school</span>
                        √âtudiants Inscrits ({{ enrollments.count }})
                    </h2>
                </div>
                
                <div class="p-6">
                    {% if enrollments %}
                        <div class="mb-4">
                            <input type="text" 
                                   id="enrolledSearch" 
                                   placeholder="üîç Rechercher un √©tudiant inscrit..."
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div id="enrolledList" class="space-y-3 max-h-96 overflow-y-auto">
                            {% for enrollment in enrollments %}
                            <div class="student-card bg-gray-50 rounded-lg p-4 flex items-center justify-between border border-gray-200">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                        <span class="text-blue-600 font-bold">{{ enrollment.student.user.first_name|first }}{{ enrollment.student.user.last_name|first }}</span>
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900">
                                            {{ enrollment.student.user.first_name }} {{ enrollment.student.user.last_name }}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            <span class="material-icons text-xs mr-1">email</span>{{ enrollment.student.user.email }}
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            <span class="material-icons text-xs mr-1">calendar_today</span>Inscrit le {{ enrollment.enrollment_date|date:"d/m/Y" }}
                                        </div>
                                    </div>
                                </div>
                                
                                <button onclick="removeStudent({{ enrollment.student.id }}, '{{ enrollment.student.user.first_name }} {{ enrollment.student.user.last_name }}')"
                                        class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded-lg text-sm font-medium transition-colors duration-200">
                                    <span class="material-icons text-sm mr-1">remove</span>Retirer
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <div class="text-6xl mb-4">
                                <span class="material-icons text-6xl text-gray-400">inbox</span>
                            </div>
                            <p class="text-gray-500">Aucun √©tudiant inscrit dans cette classe</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Available students to enroll -->
            <div class="bg-white rounded-lg shadow-lg">
                <div class="bg-gradient-to-r from-green-600 to-teal-600 text-white p-6 rounded-t-lg">
                    <h2 class="text-xl font-bold flex items-center">
                        <span class="material-icons mr-2">person_add</span>
                        √âtudiants Disponibles ({{ available_students.count }})
                    </h2>
                </div>
                
                <div class="p-6">
                    {% if available_students %}
                        <div class="mb-4">
                            <input type="text" 
                                   id="availableSearch" 
                                   placeholder="üîç Rechercher un √©tudiant disponible..."
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        
                        <div id="availableList" class="space-y-3 max-h-96 overflow-y-auto">
                            {% for student in available_students %}
                            <div class="student-card bg-gray-50 rounded-lg p-4 flex items-center justify-between border border-gray-200">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                        <span class="text-green-600 font-bold">{{ student.user.first_name|first }}{{ student.user.last_name|first }}</span>
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900">
                                            {{ student.user.first_name }} {{ student.user.last_name }}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            <span class="material-icons text-xs mr-1">email</span>{{ student.user.email }}
                                        </div>
                                        {% if student.grade %}
                                        <div class="text-xs text-gray-400">
                                            <span class="material-icons text-xs mr-1">school</span>Niveau: {{ student.grade.name }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <button onclick="addStudent({{ student.id }}, '{{ student.user.first_name }} {{ student.user.last_name }}')"
                                        class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded-lg text-sm font-medium transition-colors duration-200">
                                    <span class="material-icons text-sm mr-1">add</span>Ajouter
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <div class="text-6xl mb-4">
                                <span class="material-icons text-6xl text-green-500">check_circle</span>
                            </div>
                            <p class="text-gray-500">Aucun √©tudiant disponible pour inscription</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <div class="flex flex-col sm:flex-row gap-4">
                <a href="{% url 'academic:classroom_detail' classroom.id %}" 
                   class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg text-center font-medium transition-colors duration-200">
                    ‚Üê Retour aux d√©tails de la classe
                </a>
                
                <button onclick="window.print()" 
                        class="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-6 py-3 rounded-lg font-medium transition-colors duration-200">
                    <span class="material-icons text-sm mr-1">print</span>Imprimer la liste
                </button>
                
                <a href="{% url 'academic:classroom_list' %}" 
                   class="flex-1 bg-purple-100 hover:bg-purple-200 text-purple-700 px-6 py-3 rounded-lg text-center font-medium transition-colors duration-200">
                    <span class="material-icons text-sm mr-1">class</span>Toutes les classes
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4" id="modalTitle"></h3>
                <p class="text-gray-600 mb-6" id="modalMessage"></p>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeModal()" 
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors duration-200">
                        Annuler
                    </button>
                    <button id="confirmButton" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200">
                        Confirmer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Search functionality
document.getElementById('enrolledSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const students = document.querySelectorAll('#enrolledList .student-card');
    
    students.forEach(card => {
        const name = card.querySelector('.font-medium').textContent.toLowerCase();
        const email = card.querySelector('.text-gray-500').textContent.toLowerCase();
        
        if (name.includes(searchTerm) || email.includes(searchTerm)) {
            card.style.display = 'flex';
        } else {
            card.style.display = 'none';
        }
    });
});

document.getElementById('availableSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const students = document.querySelectorAll('#availableList .student-card');
    
    students.forEach(card => {
        const name = card.querySelector('.font-medium').textContent.toLowerCase();
        const email = card.querySelector('.text-gray-500').textContent.toLowerCase();
        
        if (name.includes(searchTerm) || email.includes(searchTerm)) {
            card.style.display = 'flex';
        } else {
            card.style.display = 'none';
        }
    });
});

// Modal functions
function showModal(title, message, onConfirm) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    document.getElementById('confirmButton').onclick = onConfirm;
    document.getElementById('confirmModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('confirmModal').classList.add('hidden');
}

// Add student function
function addStudent(studentId, studentName) {
    showModal(
        'Ajouter un √©tudiant',
        `√ätes-vous s√ªr de vouloir ajouter ${studentName} √† cette classe ?`,
        function() {
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "academic:enrollment_manage" classroom.id %}';
            
            // CSRF token
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = '{{ csrf_token }}';
            form.appendChild(csrfToken);
            
            // Action
            const action = document.createElement('input');
            action.type = 'hidden';
            action.name = 'action';
            action.value = 'add';
            form.appendChild(action);
            
            // Student ID
            const studentIdInput = document.createElement('input');
            studentIdInput.type = 'hidden';
            studentIdInput.name = 'student_id';
            studentIdInput.value = studentId;
            form.appendChild(studentIdInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    );
}

// Remove student function
function removeStudent(studentId, studentName) {
    showModal(
        'Retirer un √©tudiant',
        `√ätes-vous s√ªr de vouloir retirer ${studentName} de cette classe ?`,
        function() {
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "academic:enrollment_manage" classroom.id %}';
            
            // CSRF token
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = '{{ csrf_token }}';
            form.appendChild(csrfToken);
            
            // Action
            const action = document.createElement('input');
            action.type = 'hidden';
            action.name = 'action';
            action.value = 'remove';
            form.appendChild(action);
            
            // Student ID
            const studentIdInput = document.createElement('input');
            studentIdInput.type = 'hidden';
            studentIdInput.name = 'student_id';
            studentIdInput.value = studentId;
            form.appendChild(studentIdInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    );
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});

// Close modal on background click
document.getElementById('confirmModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}
